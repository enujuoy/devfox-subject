<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header.html :: head" />
<body>
<div th:replace="fragments/header.html :: header ('admin')"></div>
<div class="row">
    <div class="offset-1 col-10">
        <form class="form-group" align="center" style="height: 40px;" th:method="get"
              th:action="|@{/users/admin (keyword=${keyword})}|">
            <input type="text" name="keyword" th:value="${keyword}" placeholder="ニックネームを入力してください" style="height: 100%; width: 30%;">
            <button class="btn search-btn" type="submit">検索</button>
        </form>
        <br/><br/>
        <table class="table list-table table-hover text-center">
            <thead style="background-color: #A5F1E9">
            <tr>
                <th style="width: 5%">#</th>
                <th style="width: 15%">ユーザーID</th>
                <th style="width: 15%">ニックネーム</th>
                <th style="width: 10%">ランク</th>
                <th style="width: 15%">登録日</th>
                <th style="width: 10%">投稿数</th>
                <th style="width: 10%">コメント数</th>
                <th style="width: 10%">押したいいね数</th>
                <th style="width: 10%">もらったいいね数</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="user: ${users}"
                th:onclick="|location.href='@{/users/admin/{userId} (userId=${user.id}, page=${users.getNumber()}+1, keyword=${keyword})}'|">
                <th style="width: 5%" th:text="${user.id}"/>
                <th style="width: 15%" th:text="${user.loginId}"/>
                <th style="width: 15%" th:text="${user.nickname}"/>
                <th style="width: 10%" th:text="${user.userRole}"/>
                <th style="width: 15%" th:text="${#temporals.format(user.createdAt, 'yy/MM/dd HH:mm')}"/>
                <th style="width: 10%" th:text="${user.boards.size}"/>
                <th style="width: 10%" th:text="${user.comments.size}"/>
                <th style="width: 10%" th:text="${user.likes.size}"/>
                <th style="width: 10%" th:text="${user.receivedLikeCnt}"/>
            </tr>
            </tbody>
        </table>
    </div>
    <ul id="paging-ul" class="pagination justify-content-center"></ul>
</div>
<script th:inline="javascript">
    window.onload = function () {
        let nowPage = [[${users.getNumber()}]] + 1;    // 現在のページ
        let totalPage = [[${users.getTotalPages()}]];  // 全ページ数

        let firstPage;  // 表示される最初のページ
        for (let i = nowPage ; i >= 1 ; i --) {
            if(i % 5 == 1) {
                firstPage = i;
                break;
            }
        }

        let lastPage;   // 表示される最後のページ
        let nextButton; // 次のボタン表示
        if (firstPage + 4 >= totalPage) {
            lastPage = totalPage;
            nextButton = false;
        } else {
            lastPage = firstPage + 4;
            nextButton = true;
        }

        // HTML生成
        let pageHtml = "";
        pageHtml += "<li><a class='page-link' href='" + makeUrl(1) +  "'>&laquo;</a></li>";
        if (firstPage != 1) {
            pageHtml += "<li><a class='page-link' href='" + makeUrl(firstPage - 1) +  "'>&lsaquo;</a></li>";
        }

        for (let i = firstPage; i <= lastPage; i++) {
            if (i == nowPage) {
                pageHtml += "<li class='page-item active'><a class= 'page-link'>" + i + "</a></li>";
            } else {
                pageHtml += "<li class='page-item'><a class= 'page-link' href='" + makeUrl(i) + "'>" + i + "</a></li>";
            }
        }

        if (nextButton) {
            pageHtml += "<li><a class='page-link' href='" + makeUrl(lastPage + 1) +  "'>&rsaquo;</a></li>";
        }
        pageHtml += "<li><a class='page-link' href='" + makeUrl(totalPage) +  "'>&raquo;</a></li>";

        $("#paging-ul").html(pageHtml);
    }

    function makeUrl(page) {
        let url = "/users/admin?page=" + page;

        // 検索していた場合、URLに追加
        let keyword = [[${keyword}]];
        url += "&keyword=" + keyword;

        return url;
    }
</script>
</body>
</html>
